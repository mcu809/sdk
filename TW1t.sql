CREATE TABLE PUBLISHER
(
    PNAME VARCHAR(20),
    PADDRESS VARCHAR(20),
    PHONE INT,
    PRIMARY KEY(PNAME)
);

INSERT INTO PUBLISHER VALUES('P1', 'PA1', 11);
INSERT INTO PUBLISHER VALUES('P2', 'PA2',22);
INSERT INTO PUBLISHER VALUES('P3', 'PA3', 33);
INSERT INTO PUBLISHER VALUES('P4', 'PA3', 44);

CREATE TABLE BOOK
(
    BOOKID INT,
    TITLE VARCHAR(20),
    PNAME VARCHAR(20),
    PYEAR INT,
    PRIMARY KEY(BOOKID),
    FOREIGN KEY (PNAME) REFERENCES PUBLISHER (PNAME)
);

INSERT INTO BOOK VALUES(1, 'T1', 'P1', 1998);
INSERT INTO BOOK VALUES(2, 'T2', 'P2', 2000);
INSERT INTO BOOK VALUES(3, 'T3', 'P3', 2001);
INSERT INTO BOOK VALUES(4, 'T4', 'P4', 2002);

CREATE TABLE AUTHORS
(
    BOOKID INT,
    ANAME VARCHAR(10),
    PRIMARY KEY(BOOKID, ANAME),
    FOREIGN KEY (BOOKID) REFERENCES BOOK(BOOKID)
);

INSERT INTO AUTHORS VALUES(1, 'A1');
INSERT INTO AUTHORS VALUES(2, 'A2');
INSERT INTO AUTHORS VALUES(3, 'A3');
INSERT INTO AUTHORS VALUES(4, 'A4');

CREATE TABLE BRANCH
(
    BRANCHID INT,
    BRANCHNAME VARCHAR(10),
    BADDRESS VARCHAR(10),
    PRIMARY KEY(BRANCHID)
);

INSERT INTO BRANCH VALUES(1, 'BR1', 'BRADDR1');
INSERT INTO BRANCH VALUES(2, 'BR2', 'BRADDR2');
INSERT INTO BRANCH VALUES(3, 'BR3', 'BRADDR3');
INSERT INTO BRANCH VALUES(4, 'BR4', 'BRADDR4');

CREATE TABLE BOOKCOPIES
(
    BOOKID INT,
    BRANCHID INT ,
    NOOFCOPIES INT,
    PRIMARY KEY(BOOKID, BRANCHID),
    FOREIGN KEY (BOOKID) REFERENCES BOOK(BOOKID),
    FOREIGN KEY (BRANCHID) REFERENCES BRANCH(BRANCHID)
);
INSERT INTO BOOKCOPIES VALUES(1, 1, 10);
INSERT INTO BOOKCOPIES VALUES (2, 1, 10);
INSERT INTO BOOKCOPIES VALUES (3, 2, 10);
INSERT INTO BOOKCOPIES VALUES (4, 2, 10);


CREATE TABLE BOOKLENDING
(
    BOOKID INT,
    BRANCHID INT,
    CARDNO INT,
    DATEOUT DATE,
    DUEDATE DATE,
    PRIMARY KEY(BOOKID, BRANCHID, CARDNO),
    FOREIGN KEY (BOOKID) REFERENCES BOOK(BOOKID),
    FOREIGN KEY (BRANCHID) REFERENCES BRANCH(BRANCHID)
);


INSERT INTO BOOKLENDING VALUES(1, 1, 1, DATE '2017-01-01', DATE '2017-03-01');
INSERT INTO BOOKLENDING VALUES(2, 2, 1, DATE '2017-02-01', DATE '2017-04-01');
INSERT INTO BOOKLENDING VALUES(3, 3, 1, DATE '2017-03-01', DATE '2017-05-01');
INSERT INTO BOOKLENDING VALUES(4, 4, 1, DATE '2017-04-01', DATE '2017-06-01');
INSERT INTO BOOKLENDING VALUES(4, 4, 2, DATE '2017-05-01', DATE '2017-07-01');

SELECT BC.BRANCHID, BC.BOOKID, BK.TITLE,BC.NOOFCOPIES, BK.PNAME,BA.ANAME
FROM BOOKCOPIES BC, 
    BOOK BK, 
    AUTHORS BA
WHERE BC.BOOKID = BK.BOOKID 
AND BA.BOOKID = BK.BOOKID;

SELECT CARDNO FROM BOOKLENDING
WHERE DATEOUT BETWEEN DATE '2017-01-01' AND  DATE '2017-06-30'
GROUP BY CARDNO
HAVING COUNT(*) > 3;

CREATE VIEW YP2001 AS
		SELECT * FROM BOOK WHERE PYEAR = 2001;

SELECT BK.BOOKID, BK.TITLE,
    (
        (   
            SELECT SUM(NOOFCOPIES)
            FROM BOOKCOPIES
            WHERE BOOKID=BK.BOOKID
        ) 
        -
 	    (
            SELECT COUNT(*)
            FROM BOOKLENDING BL
            WHERE BL.BOOKID=BK.BOOKID
        )
    ) AS CNT
FROM BOOK BK;

DELETE FROM BOOK WHERE BOOKID=1;